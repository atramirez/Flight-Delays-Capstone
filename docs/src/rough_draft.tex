\documentclass[a4paper,12pt]{article}

\usepackage{graphicx} 
\usepackage{subfigure}
\usepackage{pythonhighlight}
\begin{document}

\title{ORD Flight Delays}
\author{Aden Ramirez}
\maketitle

\begin{abstract}
\end{abstract}

%TODO ATR: Need to add 4-8 sections
%TODO: need to fix formatting, last probably

\pagebreak

\tableofcontents

\pagebreak

\section{Project Plan}

\subsection{Data:}

\textbf{\underline{Source:}} Bureau of Transportation Statistics

\noindent \textbf{\underline{About:}}
The data being analyzed is sourced from the U.S Bureau of Transportation Statistics, part of the
Department of Transportation. This data is collected by the Bureau is sourced from each U.S
based airline self-reports each month. This includes each flight details that would be seen at
any airport, its operation time on the ground, air, and deviation from scheduled times. This also
includes some data beyond the flight itself such as the cause of delay and how long each is
contributing to the overall total. In the event of a diversion or cancellation that is also observed
and coded with reasons, and its destination. There is a lot of terms used that will need to be
well defined in the project to assist in the readers understanding but is well documented by the
organization.

\noindent \textbf{\underline{Organization Details:}}

\textbf{Primary Company Details:}

Address:

Bureau of Transportation Statistics (BTS)

1200 New Jersey Avenue, SE

Washington, DC 20590

United States

\textbf{Company Communication:}

Website: https://www.bts.gov/

Phone: 800-853-1351

Alt Phone: 202-366-3282

Business Hours:

8:30am-5:00pm ET, M-F

\textbf{Key Leaders:}

Ms. Patricia S. Hu: Director of the Bureau of Transportation Statistics

Dr. Rolf R. Schmitt: Deputy Director of the Bureau of Transportation Statistics

\subsection{Research Motivation:}

The U.S air travel system is a convoluted complex system, this past year we have seen the
effects of natural disasters effecting holiday travel. Even after we witnessed a meltdown of
Southwest airlines that was completely operational. Airlines have huge amounts of data
available to them, and the U.S. Department of Transportation collects huge amounts from
them. Data on delays, cancellations and diversions we can look more closely at the fragile
system and areas that have the most effect of these stutters. With data like this, airlines can
focus changes on specific areas, or be able to plan around common weather conditions in areas
of the country.

\subsection{Research Questions:}

\textbf{\underline{Research Question 1:}} \label{rq1}

Can you predict flight delays?

\noindent \textbf{\underline{Research Question 2:}} \label{rq2}

Can you predict flight departure delays, and their effect on an overall delay?

% \noindent \textbf{\underline{Research Question 3:}} \label{rq3}

% Can flight delays be prevented through operational changes?

\subsection{Hypotheses}

%TODO ATR proofread again
\textbf{\underline{Hypothesis 1:}}

Looking at different categories of flight delays and difference in actual air time vs. actual flight
time we can observe the effect of factors that are less directly related to flying the plane, but the
business surrounding it. Seeing airline meltdowns outside of a winter storm as this past year,
there are more problems than unpredictable weather. I intend to identify, quantify, and predict
where these problems can lead to delays in flights.

\noindent \textbf{\underline{Hypothesis 2:}}

When traveling often delays given have a wide range of reasons, delays often start from waiting at your gate 
for the airplane to arrive or be ready. Obviously leaving later would assume a flight arrival delay, though this is not always the case
as many factors go into a planes flight such as wind, route and the speed they fly at. At a certain point a departure delay 
would become a guaranteed delay, and predicting this could allow for better planning.

% \noindent \textbf{\underline{Hypothesis 3:}}

% Over the years some of the same flights have gotten scheduled longer even as planes have
% gotten faster and more aerodynamic. There have also been more and more flights being added
% to airlines rosters. Are these behaviors reflected from an expectation of delays? Flying from two
% busy airports such as LAX-JFK there is more time on the ground to maintain safe separation and
% avoid incident.

\section{Literature Review}

As the air travel has grown substantially over the past 60 years, the investment in new facilities, aircraft and improved efficiency has grown along with it.
Airlines in the United States pour huge amounts of time and effort into reducing delays each year. In the past 10 years we have observed delays hover around 20\%
in the country, with the exception of 2020. To further understand delays and what exists in the data science realm, I explore some of the research and their discoveries.

To begin identifying some areas of interest is important to further understand the topic and begin the design of a model. “As seen in Figure 1,
there are six major themes regarding the flight delay: departure, arrival, propagation, airline, airport, and air system”\cite{doi:10.1080/01441647.2020.1861123}.%(Carvalho, Sternberg, A., p. 502)
As they point out all these areas have significant impact on a flight, from facilities to actual flying, focusing on one of these and using the rest as aspects in a prediction
will allow for a good model to be developed, but be loosely applicable to the rest. Knowing areas of interest allow me to break down further and apply data science to a smaller area.

The data to be used is a good foundation for this exploration. In multiple articles On the relevance of data science for flight delay research: a systematic review. Transport Reviews,
Estimating Flight Departure Delay Distributions-A Statistical Approach With Long-Term Trend and Short-Term Pattern, and Predictive Modelling: Flight Delays and Associated Factors,
Hartsfield–Jackson Atlanta International Airport applicable data techniques were applied to sets sourced mainly from two organizations. These organizations being the Federal Aviation Administration (FAA)
and Bureau of Transportation Statics (BTS). Both reputable government organizations, the FAA regulating all encompassing air travel, and BTS reporting data around transportation.
The set we have chosen has been referenced in multiple studies, pulling from the BTS database of on-time flight statistics. 

Applying methods on this data would build towards some next steps of research that provides further progress in the field. “One step in that direction would be to try to extract, from individual airline–airport models,
the effects that contribute to NAS-wide delay. Such an approach would provide more insight into the general structure of delays, and also would be easier to maintain and update on a NAS-wide basis”\cite{doi:10.1198/016214507000000257}. %( Tu, Ball, M. O., \& Jank, p.124).
 This set will be used to predict delays in Chicago’s O’Hare International Airport (ORD), using methods such as regression, bringing another airport model that could support or refute findings at other airports contributing to a national level of predictions.

Looking at airport specific studies some consideration must be given to the data with methods used. For example in “Since we faced a problem of unbalanced classes with 86\% of flights without delay and 14\% of delayed flights
 and since this problem can lead to a false classification accuracy [20,21] we applied a sampling technique to minimize it”\cite{HENRIQUES2018638}. Classification being used in their studies had to build on top of cleaning to maximize accuracy. %(Henriques, \& Feiteira, I, p.641).
  Methods being used include regression, classification, and neural networks. I plan to build on top of their work and with working on a specific airport and tailoring data preparation. Data is tailored to each airport or airline,
   or even airport and airline in these articles and examining their methods they can be tweaked to be useful for ORD. 

Research in flight delays is extensive, though much of airline delay prediction is a more closely guarded secret as they use this to build their flight schedules. Looking at different reasons for delays reveals some areas of focus.
 My research will focus on the airport and using other identifiers for the model, but this allows the narrowing of the dataset, and can contribute to a national prediction adding an airport to extrapolate national identifiers.
  The data being used is reliable and referenced in multiple research articles,
  allowing for some questions to be expanded from others. Methods and cleaning must be tailored to the airport, but may be similar to previous research, which can help finding the most prominent variables that effect a flight delay.
   This research will expand the knowledge base with ORD delay research, introducing more up to date data.


\section{Exploratory Data Analysis}

\begin{abstract}
    ORD is one of the biggest and busiest airports in the United States supporting hundreds of thousands of flights a year.
    The data that will be analyzed November 2021 - November 2022 flights at O'Hare international Airport obtained from the Bureau of Transportation Statistics.   
    This exploratory data analysis will explain te process of cleaning the data and its methods. Then will explore some basic stats on delays, and how the airport itself is used 
    and delayed. Last a couple intuitions of some possible variable relationships will be visualized.
\end{abstract}

\pagebreak

\subsection{Important Terms}
This contains some terms and information that will be used throughout the EDA that may not be common knowledge to help you understand. 

\subsubsection{General}

\textbf{Delay} - A flight delay is defined by the Federal Aviation Administration (FAA) as a flight arriving 15 minutes or longer after scheduled arrivals time

\subsubsection{Governing Bodies}
\noindent \textbf{FAA} - Federal Aviation Administration is (FAA) is the governing body of all aviation in the U.S from aircraft certification to air traffic control

\noindent \textbf{DOT} - Department of Transportation (DOT) is a governing body that regulates all transportation, in this case they offer many unique identifiers 
and are the parent body to the Bureau of Transportation Statistics (BTS) that the data is sourced from.

\noindent \textbf{IATA} - International Air Transport Association (IATA) is an organization that makes a standard for transport type aircraft and in our case create the airport codes referenced
throughout this research. 

\noindent \textbf{ICAO} - International Civil Aviation Organization (ICAO) is a United Nations body that has standards for worldwide air travel. They are less important in this research as we look at domestic travel,
they do play in role in how the U.S forms their regulations.

\subsubsection{Airline Theory}

\textbf{Hub and Spoke} - This is a major theory of how to operate and airline, in short it means the airline has many big airport hubs that fly to other hubs.
Each hub will then fly the passenger to their final destination.

\noindent \textbf{Point to Point} - This is another rivaling theory to hub and spoke, this means the airline will just fly the airport to the destination with not stop.

\subsection{The Data} \label{data}
This data was collected from the Bureau of Transportation Statistics (BLS) as part of the online Airline On-Time Arrival Performance Data. 
I selected one year of data to begin, choosing the most recent as of January 2023. The data range spans all U.S. Carriers flying domestically over the course of November 2021 - November 2022.
The data has many fields totaling to 120 columns. BLS provides an excellent readme that explains each data field, though I will highlight some very important ones to my research here.

\emph{Note: \_ is not shown in these data types as they appear in the .CSV}

\subsubsection{Basics}
There are a lot of columns that are basic information that would be expected of most sets, there is alot of options in this set with plenty of formating opertunity.

\textbf{Year} - Year (4 digit)

\textbf{Quarter} - Quarter of the year (1-4)

\textbf{Month} - Month

\textbf{DayofMonth} - Day date of the month

\textbf{DayofWeek} - Day in words, such as 'Monday'

\textbf{FlightDate} - Flight Date Aggregation (yyyymmdd)

\subsubsection{Indentifiers}
There are many identifiers included that are not entirely useful for my use as a DOT Marketing ID, but worth having should there be NA data columns that can be cross referenced.
There is also multiple ways to identify \emph{anything} in aviation, so there are international Air Transport Association(IATA) and US identifiers in this set.
The most important for my analysis are:

\textbf{Marketing Airline Network} - These are common codes for airlines someone would see on their ticket, such as UA for United Airlines 

\textbf{Tail Number} - Aircraft Tail Number, can uniquely identify a register aircraft

\textbf{Flight Number Operating Airline} - Flight number as you would see on a ticket for example: UA1234

\subsubsection{Flight Information}

\subsubsection{Route Information}
All the information pertaining to the route of the flight:

\textbf{Origin} - Origin Airport in IATA standard (3 Letter) Example: ORD or PHX

\textbf{OriginCityName} - Origin Airport City (There are special cases such as CLT)

\textbf{OriginState} - Origin State Code

\textbf{OriginStateFips} - Origin State FIPS code, this will allow for adding state geometry in maps

\textbf{OriginStateName} - Origin State Name string

\textbf{Dest} - Destination Airport in IATA standard

\textbf{DestCityName} - Destination Airport City

\textbf{DestState} - Destination State Code

\textbf{DestStateFips} - Destination State FIPS code, this will allow for adding state geometry in maps

\textbf{DestStateName} - Destination State Name string

\subsubsection{Delay Information}
All the information pertaining to the timing of the flight, and delay if applicable. There is much more, but this is a good focus for the analysis and EDA.
Extensive diversion information is not included, as it is noted, but not the focus of the research.

\textbf{CRSDepTime} - CRS Departure Time (local time: hhmm)

\textbf{DepTime} - Actual Departure Time (local time: hhmm)

\textbf{DepDelay} - Difference in minutes between scheduled and actual departure time

\textbf{DepDelayMinutes} - Difference in minutes between scheduled and actual departure time

\textbf{DepDel15} - Departure Delay Indicator if the flight is at least 15 minutes delayed

\textbf{DepartureDelayGroups} - Departure Delay intervals, every (15 minutes from $\leq$ 15 to $>$ 180)

\textbf{DepTimeBlk} - CRS Departure Time Block, Hourly Intervals

\textbf{TaxiOut} - Taxi Out Time, in Minutes

\textbf{WheelsOff} - Wheels Off Time (local time: hhmm)

\textbf{WheelsOn} - Wheels On Time (local time: hhmm)

\textbf{TaxiIn} - Taxi In Time, in Minutes

\textbf{CRSArrTime} - CRS Arrival Time (local time: hhmm)

\textbf{ArrTime} - Actual Arrival Time (local time: hhmm)

\textbf{ArrDelay} - Difference in minutes between scheduled and actual arrival time. Early arrivals show negative numbers.

\textbf{ArrDelayMinutes} - Difference in minutes between scheduled and actual arrival time. Early arrivals set to 0.

\textbf{ArrDel15} - Arrival Delay Indicator, 15 Minutes or More (1=Yes)

\textbf{ArrivalDelayGroups} - Arrival Delay intervals, every (15 minutes from $\leq$ 15 to $>$ 180 minutes )

\textbf{ArrTimeBlk} - CRS Arrival Time Block, Hourly Intervals

\textbf{Cancelled} - Cancelled Flight Indicator (1=Yes)

\textbf{CancellationCode} - Specifies The Reason For Cancellation

\textbf{Diverted} - Diverted Flight Indicator (1=Yes)

\textbf{CRSElapsedTime} - CRS Elapsed Time of Flight, in Minutes

\textbf{ActualElapsedTime} - Elapsed Time of Flight, in Minutes

\textbf{AirTime} - Flight Time, in Minutes

\textbf{Flights} - Number of Flights

\textbf{Distance} - Distance between airports (miles)

\textbf{DistanceGroup} - Distance Intervals, every 250 Miles, for Flight Segment

\textbf{CarrierDelay} - Carrier Delay, in Minutes

\textbf{WeatherDelay} - Weather Delay, in Minutes

\textbf{NASDelay} - National Air System Delay, in Minutes

\textbf{SecurityDelay} - Security Delay, in Minutes

\subsection{Data Cleaning}

\subsubsection{Aggregation}
Collecting the initial one year (11/2021-11/2022) data from BTS yields twelve separate .zip files containing a .csv file and .html documentation readme.
The first step to using this data is to concatenate all this information together into one usable format.
I accomplish this with a Python script (\ref{EDA Specific Cleaning}) using the \emph{Pandas} library. This script pulls in all .csv files into a list of Pandas Dataframes.
Once these are Pandas Dataframes it is quite simple with all variables matching, they get concatanated. 
Now with a single monolithic Dataframe, it is written to a new .csv file. (\ref{EDA Specific Cleaning})

\subsubsection{Subset Files} \label{datasubset}
This research is focusing on a single airport, Chicago O'Hare International Airport. The data sourced is for all U.S Airline Carriers that fly domestically.
The first step in cleaning this data is to properly subset the information into a smaller, less bloated file to reference (\ref{ohre subset}). My approach will produce to files as output.

First, one main file will use the \emph{Pandas} library in Python to pull in our single monolithic csv file into a Dataframe. From here it is quite simple to mask only the data we want.
I filter by either the \emph{Origin} or \emph{Dest} to be the airport of interest ORD.
Once this mask is applied, the values are verified to be an expected value, and once again exported using the next masked dataframe to a separate .csv file. 

Second, a second file that contains only variables being heavily used, to help with operation speed. All the variables listed in section Figure \ref{data} will be maintained.
The process will follow the same process as section Figure \ref{datasubset}. The output will be a much more compact file to operate on, to aid speed for the EDA and future model development.

\subsubsection{NA Values}
Now that the data has been subset into what will be used to explore, the next concern is NA values. There are some columns where this is acceptable, but other such as out delay times
that are not. The first step is finding all the columns that have an NA value and then determining what the value should be replaced with. Many of the delay related columns have many NA values,
the delay types (Weather, NAS, Security, and Late Aircraft) are null if they are not applicable. These columns get their NA values set to 0, as in no delay minutes. This takes care of the NAs that could corrupt data.
The last big concerning item is flights that have no delay value, either arrival delay or arrival delay minutes, which could not be created. (\ref{EDA Specific Cleaning}) Any NAs of these are dropped.
This operation dropped \emph{17004} data points. This is significant, but still far less than 5\% of all the data. This now leaves the data with \emph{582721} observations.

\subsubsection{Miscellaneous}
Outliers in this dataset can get large. I decided to explore with a data subset where all delays are \emph{6 hours (720 min.)} or less (still including non-delays). This decision is not final as a better
consideration for what an outlier is should be conducted in this set. This does simplify understanding the data, and making the point through visualization easier for the purpose of this EDA.
With this data mask the observations left is now \emph{582045}.

\subsection{Exploratory Data Analysis}

To begin exploring the data there is some basic information to gather to learn about this data and begin to show some areas that may be worth investigating further with machine learning models.

\textbf{ORD Amount of Flights}: 582045

\textbf{ORD Amount of Delays}: 106187

\textbf{ORD Percent of Flights Delayed}: 18\%

\textbf{ORD All Flights Delay Mean}: 3 minutes

\textbf{ORD All Flights Delay Median}: -8 minutes (8 minutes early!)

\textbf{ORD Delayed Flights Mean}: 67 minutes

\textbf{ORD Delayed Flights Median}: 42 minutes

To begin breaking down the delays that occur, there are five categories officially made by the FAA in this data set tracked. Carrier Delay, Late Aircraft Delay, National Air System Delay, Security Delay, and Weather Delay.

\begin{figure}
    \centering
    \includegraphics*[scale=.5]{../../img/ord_delay_split_pie.png}
    \caption[Delays by Type]{ORD Delays by Type}
    \label{fig:delaybytype}
    As seen in Figure \ref{fig:delaybytype} the two biggest delays are by carrier and late aircraft. The research questions are going to dive much deeper in how these delays are created and interacted with by airline and airport staff. Prediciting and eliminating 
    these delays could say millions of hours a year.
\end{figure}


\begin{figure}
    \centering
    \includegraphics*[scale=.40]{../../img/3h_box.png}
    \caption[]{}
    \label{fig:3hbox}
    In Figure \ref{fig:3hbox} This box plot is capped at the highest delay group in the data, 180 minutes or 3 hours. The large amount of flights are delayed for short amounts of time, but you can see the 
    two largest areas cover much higher ranges of delays.    
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[scale=.45]{../../img/3h_kde.png}
    \caption[]{}
    \label{fig:3hkde}
    In Figure \ref{fig:3hkde} looking at arrival delays, we can see the highest density peaks well before the hour mark sharply decreasing to a non zero
    before the max included amount (180 minutes).
\end{figure}


\begin{figure}
    \centering
    \includegraphics*[scale=.40]{../../img/ord_delay_t_month.png}
    \caption[]{}
    \label{fig:delaybymonth}
    In Figure \ref{fig:delaybymonth} this reflects similar to the pie chart, of note is the summer months have a much higher delay count. The busy travel season could be contributing to this, and worth further investigation.
\end{figure}


\begin{figure}
    \centering
    \includegraphics*[scale=.35]{../../img/delays_by_airline.png}
    \caption[]{}
    \label{fig:delaybyairline}
    In Figure \ref{fig:delaybyairline} this shows the amount of delays distribution by each operating airline. United and American have the largest,
    which can be expected as ORD is a hub airport for American Airlines, and United Airlines who both fly a hub and spoke model. 
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[scale=.40]{../../img/flights_by_airline.png}
    \caption[]{}
    \label{fig:flightsbyairline} 
    In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    there is not as large a difference in their delay distributions.
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[]{../../img/dist_by_delay.png}
    \caption[]{}
    \label{fig:lm_disbydelay}
    In Figure \ref{fig:lm_disbydelay} One of the relationships I wanted to briefly look at to further think about in the coming day was distance of the flight and the arrival delay.
    This is a very stange visual I want to look into more, there is almost a recognizable cluster for certain distance airports. There's has no relationship between just these two variables.
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[]{../../img/airtime_by_delay.png}
    \caption[]{}
    \label{fig:lm_airtimebydelay}
    In Figure \ref{fig:lm_airtimebydelay} The other relationship I wanted to preview was airtime by arrival delay, the thinking being more time in the air laves possibility 
    to make up time flying faster or catching good wind. This very simple linear regression shows not simple relationship, though at a glance looks like more airline has lower delays, but there is obviously a more complex relationship.
\end{figure}

\break
\subsection{Conclusion}

This exploratory data analysis cleaned the data to be more usable, identified some areas the data could be improved, and explored some basic relationships.
Moving forward to modelling some this EDA will prove valuable to understanding the data, and helping work towards the data being easily workable for machine learning models.
\subsubsection{Data Improvement}
During the EDA there is some spots of the data that can be improved and expanded. For future visualizations it would be helpful to have a nicer way of showing information
such as airline names or even a map showing where flights go. There are supporting tables provided by BTS that would assist in expanding tha data. Another consideration is how to deal with outliers when building models
there is a large range, that shouldn't eliminate all high delays. This should be solved mathematically and researched what the FAA considers long delays, or a point of where delay is considered a new flight. Working with the data 
could also be made easier with some table work, on the names, and adding new information that is used more than once.

\subsubsection{Relationships and Methods}
In the EDA only a couple areas were explored, and both showed the problem is much more complex than a linear regression. Thinking ahead I think the possibility of a logistic regression is there that could provide a good predictor or a delay.
Another area I did not consider earlier is trees that could prove promising. There may be the need for some dimension reduction as these complex relationships may start adding uo in variable size. Lastly clustering may still be a good option where there are splits on more focused data.

\section{Methodology}

\subsection{Research Question 1}
Can flight delays be predicted?

For this question we want a good overall look at stages of a flight, taxi, departure, landing, taxi, and arrival. The goal is to categorize if a flight will be delayed,
this is useful for airlines and people for expectations and planning around it. However there should also be an attempt at predicting the length of the delay to make 
the information more meaningful. This question will be solved with three different methods.

\subsubsection{Method 1}

The first method for this question that will be applied is logistic regression. This method will have two possible categorical outputs, being the flight is delayed
or the flight is not delayed (Using $>$15m FAA definition). Logistic regression is great for two class problems, and will fit well here.

\subsubsection{Method 2}
The second method for this research question is also a logistic regression, but using more categorical outputs. These being our delay groups that are used in the dataset. They are not delayed, 15 minutes - 30 minutes, and builds all 15 minute increments
up to 180 minutes for a total of 15 possible groups. The attempt in this method is to see with the data if logistic regression can be expanded as a good predictor for more specific
flight delay information.

\subsubsection{Method 3}
The third method for this research question is a random forest decision tree, but using the group of 15. These being our delay groups that are used in the dataset. They are not delayed -15 minutes , 15 minutes - 30 minutes, and builds all 15 minute increments
up to 180 minutes for a total of 15 possible groups. The power of the decision tress will allow to go beyond saying a flight is delayed or not, and offer a range following the ranges the DOT provides.

\subsection{Research Question 2}
Can flight departure delays be predicted?

\subsubsection{Method 1}
The first method for this question that will be applied is logistic regression. This method will have two possible categorical outputs, being the airport is the main delay
or other.

\subsubsection{Method 2}
The second method being applied for this research question is a random forest decision tree. This method will output multiple categories corresponding to the type fo delay possible.


\subsection{Research Question 3}
Can flight delays be prevented through operational changes?

From the EDA flight delays obviously have a bias towards late aircraft and airlines operations such as preparing the plane after the previous flight. 
Minimizing delays means more people flying and more money for the airline, looking at how these operations play into a predicition can allow understanding for 
the effect working towards minimization could have on the industry.

This research question is supported by the machine learning methods of the previous questions, and will be explored through model training results
and data validation.

\subsection{Validation}
With the methods being used, there will need to be many validation methods used. For logistic regression there will need to be simple classification measures such as accuracy and precision that can be determined
testing the model on a subset of the data. With this info sensitivity and specificity can also be calculated, and all reported in a table before the next method. An ROC curve will also be used as a nice visual for these values calculated.
For decision trees there will be variable importance measures and predictions verified on a subset of the data. Both will start with 75\% of the data being used for training and the last 25\% to be used in validation.

\subsection{Data}
For the models in this research question we will provide:

Airline

Origin

Departure Block

Departure Delay

Destination

Arrival Block

Arrival Delay (Time in minutes)

Arrival Delay (True or False)

Distance 

Carrier Delay

Late Aircraft Delay

Air System Delay

Security Delay

Weather Delay

Taxi Time

\section{Ethical Recommendations}

There are some ethical considerations for the tooling and analysis developed in this project looking closer at O'Hare International Airport flight delays.
Predicting flight delays is hugely beneficial to the industry, allowing for carriers to plan ahead and work towards eliminating preventable delays.
With this information though there are so problems that could arise such as delaying a flight that needs to be cancelled, prolonging the issues for the customer,
or over adjusting for predicted delays by moving the flight time dramatically to attempt to avoid a delay.

Airlines are widely known to have a low margin for profits, cutting costs, and maximizing money from flights. Carriers want to avoid any extra costs possible especially 
having to accommodate a passenger who's flight has been cancelled. Predicting flight delays, and getting the precision down to a block, even if the block is large could
allow for an airline to hold out cancelling a flight in the name of cost savings, since they believe they can see it would be a long delay, or even just extend the time, being
more inconvenient for the passengers. This would not necessarily be industry breaking, but would leave an opportunity for airlines to skirt costs and create situations
that would not be in the favor of the customer.

Another consideration that is closely related, predicting flight delays, especially when looking at block departure or arrival times historically airlines would likely
adjust their schedules each year to account for this. This is common, and isn't bad in itself, flights are large airports often have more padding with a higher average taxi
time. This does leave the ability to "over-adjust" when seeing a flight it likely to be delayed where they could add a later arrival time not only to pad from a long taxi, but 
an anticipated delay. This over adjustment could lead to longer flight (total not in air) times that could have an effect throughout the system, but not actually having 
a delayed flight since with new pad, it is technically on time or even early if the adjustment becomes too extreme. 

Carriers reputation is important to their business with a low margin, highly competitive industry, they will take every chance to increase their reputation or cut cost.
With this analysis and implementation this information could be used to assist and airline with that, and of course could effect the future of airline schedules where total flight
time is increased more than it should be in order to padding time to avoid delays. The information must be use responsibly and not adding unnecessary time to flights, that
would cause these problems.

\section{Analysis}

\subsection{Research Question 1} \label{analyze:rq1}

Research question one set out to predict flight delays at O'Hare International Airport. There were two different model types used and three total models, each with a set of challenges
and varying success. The first model used was a two class logistic regression (\ref{model:rq1_code}) that aimed to determining wether a flight was either delayed or not.
This model did not require much extra preprocessing beyond the basic model level cleaned data %(\ref{})
The data was subset (\ref{model:rq1_code}) to include some columns including the time blocks of flight and the departure delay.
Building the first logistic regression for this question brought up an issue that will continue to be encountered for many other models. Since delays are a minority, the dataset has a heavily
skewed imbalance toward on-time or early flights, following closely to the national numbers. Addressing the imbalance found here adds class weights inverse of the proportion found in the dataset.
In the EDA section (\ref{EDA Statistics Code}) these proportions were used as weights, with class 0 (no delay) having a weight of 15 and class 1 (delay) having a weight of 85. With only two classes these weights
work well as simple hyperparameters and greatly increased AUC and accuracy values. Other adjustments included random state, which is set to the class 0 weight, and a high max iteration with the amount of data to 
allow the lbfgs solver converge.
Overall the model worked very well for predicting a flight delay once the plane has begun its trip, with an accuracy of 89\%.
This is demonstrated with a confusion matrix as the first evaluation (\ref{fig:model:rq1:cfmtrx}).
In the ROC curve a great area under curve (AUC) value of 0.93 (\ref{fig:model:rq1:ROC}) was observed. The recall vs. precision curve (\ref{fig:model:rq1:prec_recall}) was slightly less promising, but still having a high enough value to be somewhat reliable.
Of note with this model, with more data before flight perhaps with airline operations
departure delays could have a lighter effect on the model's accuracy. This model would work well in determining a flight delay on a flight tracker or something of the same.

The second model was also a logistic regression model, but with 15 separate classes, one for each departure block (-15 min to 180 minutes in 15 minute increments). This model was much less successful,
showing an accuracy of 37\% and a more diverse confusion matrix (\ref{fig:model:rq1:cfmtrx_2}). Logistic regression as it stands is not the best approach for this many classes in the attempts made here. There could be improvement with further preprocessing and accounting for the imbalanced data.

The third and fourth model for research question one was based on a random forest decision tree. These models included a new type of preprocessing from the previous models, synthetic minority oversampling technique (SMOTE) which provides 
a similar desire to the first logistic regression, that oversamples the classes to bring the imbalance to a more equal level. With this another random state was added to the classifier similar to the logistic regression.
Before SMOTE was applied , the random forest classifier was seeing numbers similar to the multi class logistic regression of around 30\%, now currently having an accuracy of 60\% with multi-class and TODO\% with 2 class, a large improvement. The confusion matrix (\ref{fig:model:rq1:cfmtrx_3}) shows there is still spread,
but predicting within one or two classes meaning the error for an everyday user is not much longer than the minimum for a flight to be considered delay. 

\subsection{Research Question 2}

Research question two, predicting flight departure delays became of interest during research question one when analyzing random forest. In predicting
flight delays (\ref{analyze:rq1}) when predicting with departure delay information it provided the most important variable. Wanting to be able to use this information as early
as possible, predicting a departure delay could assist with using in further modeling. Similar to the arrival flight delays there is four models two logistic regression and two random forest decision trees.
The data used is similar to \ref{analyze:rq1} using a 2-class classification for predicting a delay or not, and multi-class following the DOT groups from 15 minutes early up to 180 minutes late. Without a strong predictor 
like departure delays are in predicting arrival delays, there is much more work to getting a good accuracy without more data that airlines may have access to. A predictor that was dropped that had a massive effect on the models was taxi out time.
This was in the objective of observing if departure delays could be predicted further out in advance., with this value accuracy could theoretically be higher, but would be used mostly in the event of predicting a delay while the flight is already left.

Both logistic regression models are using SMOTE to resample the imbalanced data of delays, which with departure delays having a distribution of 
75\% of on-time departed flights. Predicting the two class departure delays the regression model uses balanced class weights, fit intercept with an l2 penalty.
With the high need of preprocessing with weaker predictors I created a grid search for some values in the regression models (ref TODO grid search).
The outcome of this showed balanced class weights with fit intercept and l2 penalty was showing the highest accuracy score. This model proved to be okay the accuracy was TODO\% (REF TODO confusion matrix).
The AUC values was TODO\% (TODO REF AUC). This model was far less successful than logistic regression for arrival delays. Multi-class would proved to fall even further with an accuracy of TODO\%.
This was improved by adding another parameter in the multi-class regression model, C. C allows for adjusting the penalty, setting this to 0.15 showed better results which is a very
strong penalty. Logistic regression here, shows there may be a better model method for these predictions.

As above preparation for the random forest models is very similar to the previous trained models for arrival delays. (\ref{analyze:rq1})
Two class prediction was decently successful with an TODO accuracy of 75\%. This is much higher than the logistic regression, but also had a much longer runtime.
Multi-class got a lower accuracy TODO but still passable over the logistic regression. In both of these models importance features were dominated by surprisingly day of the week 
and scheduled airtime. With this information this model could feed into an overall prediction or expanded to give a numeric value to allow more accurate overall delays from further time out and not 
day of or almost in flight.

% \subsection{Research Question 3}



\section{Challenges}



\section{Recommendations}



\section{Appendix}

\subsection{Figures}

\subsubsection{Research Question 1} 

\begin{figure}
    \centering
    \includegraphics*[scale=.40]{../../img/model_rq1_cfmtrx.png}
    \caption[]{Two Class Logistic Regression Confusion Matrix}
    \label{fig:model:rq1:cfmtrx}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[scale=.45]{../../img/model_rq1_roc.png}
    \caption[]{Two Class Logistic Regression ROC Curve}
    \label{fig:model:rq1:ROC}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[scale=.45]{../../img/model_rq1_prec_recall.png}
    \caption[]{Two Class Logistic Regression Precision Vs. Recall}
    \label{fig:model:rq1:prec_recall}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[scale=.50]{../../img/model_rq1_cfmtrx_2.png}
    \caption[]{Multi-Class Logistic Regression Confusion Matrix}
    \label{fig:model:rq1:cfmtrx_2}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[scale=.50]{../../img/model_rq1_cfmtrx_3.png}
    \caption[]{Multi-Class Random Forest Decision Tree Confusion Matrix}
    \label{fig:model:rq1:cfmtrx_3}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

%TODO reference for research question 3
\begin{figure}
    \centering
    \includegraphics*[scale=.50]{../../img/model_rq1_rf.png}
    \caption[]{Multi-Class Random Forest Decision Tree Variable Importance}
    \label{fig:model:rq1:rfc_1}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

%TODO ATR classifier without knowing dep delay?

\subsubsection{Research Question 2}

\begin{figure}
    \centering
    \includegraphics*[scale=.50]{../../img/model_rq2_cfmtrx_1.png}
    \caption[]{Two Class Logistic Regression Confusion Matrix}
    \label{fig:model:rq2:cfmtrx}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[scale=.45]{../../img/model_rq2_roc.png}
    \caption[]{Two Class Logistic Regression ROC Curve}
    \label{fig:model:rq2:ROC}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[scale=.45]{../../img/model_rq2_prec_recall.png}
    \caption[]{Two Class Logistic Regression Precision Vs. Recall}
    \label{fig:model:rq2:prec_recall}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[scale=.50]{../../img/model_rq2_cfmtrx_2.png}
    \caption[]{Two Class Logistic Regression Confusion Matrix}
    \label{fig:model:rq2:cfmtrx_2}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

\begin{figure}
    \centering
    \includegraphics*[scale=.50]{../../img/model_rq2_cfmtrx_3.png}
    \caption[]{Two Class Random Forest Decision Tree Confusion Matrix}
    \label{fig:model:rq2:cfmtrx_3}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

%TODO reference for research question 3
\begin{figure}
    \centering
    \includegraphics*[scale=.50]{../../img/model_rq2_rf.png}
    \caption[]{Two Class Random Forest Decision Tree Variable Importance}
    \label{fig:model:rq2:rfc_1}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}


\begin{figure}
    \centering
    \includegraphics*[scale=.50]{../../img/model_rq2_cfmtrx_4.png}
    \caption[]{Multi-Class Random Forest Decision Tree Confusion Matrix}
    \label{fig:model:rq2:cfmtrx_4}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}


\begin{figure}
    \centering
    \includegraphics*[scale=.50]{../../img/model_rq2_rf_2.png}
    \caption[]{Multi-Class Random Forest Decision Tree Variable Importance}
    \label{fig:model:rq2:rfc_2}
    % \label{fig:flightsbyairline} 
    % In Figure \ref{fig:flightsbyairline} To show the previous figure, American and United fly the most to ORD, though there is a significantly larger amount operated by United. In Figure \ref{fig:delaybyairline} 
    % there is not as large a difference in their delay distributions.
\end{figure}

% \subsubsection{Research Question 3}


\section{Code}

\subsection{Cleaning}

\subsubsection{O'Hare Subset} \label{ohre subset}

This script gathered all the .CSV files, compiled them to one dataframe, subset to O'Hare International Airport's flights 
and exported to a single .CSV file that is referenced throughout the project.

\begin{python}
csv_path = 'C:\Code\school\DAT-490-Data\csvs'
data_lst = []

csv_files = [f for f in listdir(csv_path) if isfile(join(csv_path, f))]

for data_file in csv_files:
    this_csv_path = join(csv_path, data_file)
    data_lst.append(pd.read_csv(this_csv_path))

assert len(data_lst) == 12

flight_delays_df = pd.concat(data_lst)
print("Length of Flight Delay Data:", len(flight_delays_df))

ord_flight_delays_df = flight_delays_df.loc[ ( flight_delays_df['Origin'] == 'ORD' ) | ( flight_delays_df['Dest'] == 'ORD' ) ]

print("Length of ORD Data:", len(ord_flight_delays_df))
ord_flight_delays_df.to_csv('../data/ORD_11_21-11-22.csv')
\end{python}

\subsubsection{Model Level Data}

This script cleans the data to model level and is only used in machine learning models. This drops NA values, fills 0 for delays types and
subsets to only columns that may be needed when creating a model for this project.

\begin{python}

import pandas as pd
df = pd.read_csv("../data/ORD_11_21-11_22.csv")

#fill NA values of flight delay times by types
df['CarrierDelay'] = df['CarrierDelay'].fillna(0)
df['WeatherDelay'] = df['WeatherDelay'].fillna(0)
df['NASDelay'] = df['NASDelay'].fillna(0)
df['SecurityDelay'] = df['SecurityDelay'].fillna(0)
df['LateAircraftDelay'] = df['LateAircraftDelay'].fillna(0)



init_test_lst = ['Marketing_Airline_Network', 'Origin', 'DepTimeBlk', 'DepDelay', 'ArrTimeBlk',
                 'ArrDelay', 'Distance', 'CarrierDelay', 'WeatherDelay', 'NASDelay', 'SecurityDelay',
                  'LateAircraftDelay', 'TaxiIn', 'TaxiOut']
model_col_lst = ['DOT_ID_Marketing_Airline', 'OriginAirportSeqID', 'DepTimeBlk', 'DepDelay',
'DestAirportSeqID', 'ArrTimeBlk', 'ArrivalDelayGroups', 'ArrDelay','Distance',
'CarrierDelay', 'WeatherDelay', 'NASDelay', 'SecurityDelay', 'LateAircraftDelay',
'TaxiIn', 'TaxiOut', 'ArrDel15', 'CRSElapsedTime','CRSDepTime', 'CRSArrTime']

# blk_mapping.csv as a dict
blk_map_dict ={
    '0001-0559' : 0,
    '0600-0659' : 6,
    '0700-0759' : 7,
    '0800-0859' : 8,
    '0900-0959' : 9,
    '1000-1059' : 10,
    '1100-1159' : 11,
    '1200-1259' : 12,
    '1300-1359' : 13,
    '1400-1459' : 14,
    '1500-1559' : 15,
    '1600-1659' : 16,
    '1700-1759' : 17,
    '1800-1859' : 18,
    '1900-1959' : 19,
    '2000-2059' : 20,
    '2100-2159' : 21,
    '2200-2259' : 22,
    '2300-2359' : 23
}

# copy and apply block time mapping
model_df = df.copy()
model_df['DepTimeBlk'] = df['DepTimeBlk'].apply(lambda x: blk_map_dict.get(x))
model_df['ArrTimeBlk'] = df['ArrTimeBlk'].apply(lambda x: blk_map_dict.get(x))

model_df = model_df[model_col_lst]
print(model_df.columns)

# final drop of all left over NA values
model_df = model_df.dropna()
model_df.isna().values.any()

# write to csv for later use
print(len(model_df))
model_df.to_csv('../data/ORD_11_21-11-22_model.csv')

\end{python}

\subsection{Exploratory Data Analysis}

\subsubsection{EDA Specific Cleaning} \label{EDA Specific Cleaning}
The EDA uses some different data cleaning, as it was prepared before models. This is less strict to mappings, and uses more human readable strings.
\begin{python}

# libraries used
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

ord_df = pd.read_csv("../data/ORD_11_21-11_22.csv")

# Columns with mixed type warning, lets investigate
ord_df.iloc[:, [12, 14, 87, 94]]

# None of these columns are needed, we can ignore and create our second subfile
include_lst = ['Year', 'Quarter', 'Month', 'DayofMonth', 'DayOfWeek',
'FlightDate','Marketing_Airline_Network', 'Tail_Number',
'Flight_Number_Operating_Airline','Tail_Number', 'Origin', 'Dest',
'OriginCityName', 'OriginState','OriginStateFips',
'OriginStateName','DestCityName', 'DestState', 'DestStateFips',
'DestStateName','CRSDepTime', 'DepTime', 'DepDelay',
'DepDelayMinutes', 'DepDel15', 'DepartureDelayGroups', 'DepTimeBlk',
'TaxiOut', 'WheelsOff', 'WheelsOn',
'TaxiIn', 'CRSArrTime', 'ArrTime', 'ArrDelay', 'ArrDelayMinutes',
'ArrDel15','ArrivalDelayGroups', 'ArrTimeBlk', 'Cancelled',
'CancellationCode', 'Diverted', 'CRSElapsedTime','ActualElapsedTime',
'AirTime', 'Flights', 'Distance', 'DistanceGroup',
'CarrierDelay', 'WeatherDelay', 'NASDelay', 'SecurityDelay',
'LateAircraftDelay']
new_ord_df = ord_df[include_lst]

ord_df = new_ord_df

# gets all NA columns to further clean
def lst_na_cols():
    na_col_lst = []
    no_na_lst = []
    for i in ord_df.columns:
        if ord_df[i].isna().values.any():
            na_col_lst.append(i)
        else:
            no_na_lst.append(i)
    assert len(ord_df.columns) == (len(na_col_lst) + len(no_na_lst))

    print("NA exists in:", na_col_lst)
    print("There are no NAs in :", no_na_lst)

lst_na_cols()

# Before dealing with NA we should fill the NAs that should be zero
# These are delay times for sure
ord_df['CarrierDelay'] = ord_df['CarrierDelay'].fillna(0)
ord_df['WeatherDelay'] = ord_df['WeatherDelay'].fillna(0)
ord_df['NASDelay'] = ord_df['NASDelay'].fillna(0)
ord_df['SecurityDelay'] = ord_df['SecurityDelay'].fillna(0)

#info for development
pre_ord_df_len = len(ord_df)
ord_df = ord_df.dropna(subset=['ArrDelayMinutes', 'ArrDelay'])
print(f"Dropped {pre_ord_df_len - len(ord_df)} data points")

# lastly cap to 12 hours
ord_df = ord_df[ord_df['ArrDelay'] < 720]

\end{python}

\subsubsection{EDA Statistics Code} \label{EDA Statistics Code}

\begin{python}
ord_df.describe()

ord_delay_mean = ord_df['ArrDelay'].mean()
ord_delay_median = ord_df['ArrDelay'].median()

print("ORD All flights Delay Mean:", ord_delay_mean)
print("ORD All flights Delay Median:", ord_delay_median)

# use FAA definition of delay
ord_delays_df = ord_df['ArrDelay'] >= 15
ord_delays_df = ord_df[ord_delays_df]
ord_delay_mean = ord_delays_df['ArrDelay'].mean()
ord_delay_median = ord_delays_df['ArrDelay'].median()

print("ORD Delay Mean:", ord_delay_mean)
print("ORD Delay Median:", ord_delay_median)

flights_num = ord_df['ArrDelay'].count()
delays_num = ord_delays_df['ArrDelay'].count()
print("Amount of Flights:", flights_num)
print("Amount of Delays:", delays_num)
print("Precentage of Delayed Flights:", (delays_num/flights_num))

\end{python}

\subsubsection{EDA Plots Code}

Code for Pie Chart of delay type split at ORD.

\begin{python}
    
pie_chart_lst = [ord_df['CarrierDelay'].sum(), ord_df['WeatherDelay'].sum(),
 ord_df['NASDelay'].sum(), ord_df['SecurityDelay'].sum(), ord_df['LateAircraftDelay'].sum()]

pie_chart_labels_lst = ["Carrier Delay", 'Weather Delay', 'Air System Delay',
 'Security Delay', 'Late Aircraft Delay']

fig, ax1 = plt.subplots(1,1, figsize=(14,10))
ax1.pie(pie_chart_lst, labels=pie_chart_labels_lst, autopct='%1.1f%%', explode=(.02, .02, .02, .02, .02));
ax1.set_title("ORD Delay Split");

\end{python}

Bar plot of delays by month at ORD.

\begin{python}

fig, ax1 = plt.subplots(1,1, figsize=(14,10))

ord_delay_types_df = ord_delays_df[['Month','CarrierDelay', 'WeatherDelay', 'SecurityDelay', 'NASDelay', 'LateAircraftDelay']]
delay_cnt_month = ord_delay_types_df.groupby(by='Month').sum()
delay_cnt_month.plot(ax=ax1, kind='bar', stacked=True, cmap='jet')
ax1.set_title("ORD Delay Type by Month");
ax1.set_ylabel("Delay Count")

\end{python}

Box plot of Delay types at ORD.

\begin{python}

fig, ax1 = plt.subplots(1,1, figsize=(14,10))
ord_delay_types_df.plot.box(ax=ax1)
ax1.set_title("ORD Delay Types Box Plot");

ord_delay_types_df_2 = ord_delays_df[ord_delays_df['ArrDelay'] < 360] 
ord_delay_types_df_2 = ord_delay_types_df_2[['Month','CarrierDelay', 'WeatherDelay', 'SecurityDelay', 'NASDelay', 'LateAircraftDelay']]

fig, ax1 = plt.subplots(1,1, figsize=(14,10))
ord_delay_types_df_2.plot.box(ax=ax1)
ax1.set_title("ORD Delay Types Box Plot Capped at 6 Hours");

ord_delay_types_df_2 = ord_delays_df[ord_delays_df['ArrDelay'] < 180] 
ord_delay_types_df_2 = ord_delay_types_df_2[['CarrierDelay', 'WeatherDelay', 'SecurityDelay', 'NASDelay', 'LateAircraftDelay']]

fig, ax1 = plt.subplots(1,1, figsize=(14,10))
ord_delay_types_df_2.plot.box(ax=ax1)
ax1.set_title("ORD Delay Types Box Plot Capped at 3 Hours");

fig, ax1 = plt.subplots(1,1, figsize=(14,10))
ord_delays_df['ArrDelay'].plot(ax=ax1, kind='kde')
ax1.set_title("ORD Delay Types Box Plot Capped at 3 Hours");


\end{python}

Distributions of airline flight delays at ORD.

\begin{python}
airlines_distribution = sns.displot(data=ord_delays_df, x='ArrDelay', col='Marketing_Airline_Network', col_wrap=2, hue='Marketing_Airline_Network')
airlines_distribution.set(xlim=(0,180))

fig, ax1 = plt.subplots(1,1, figsize=(14,10))

airline_nums_flights = airline_nums['Year']
airline_nums_flights.plot.bar(ax=ax1)
ax1.set_title("Flights at ORD by Airline")

\end{python}

KDE plot of flight delay times at ORD.

\begin{python}

fig, ax1 = plt.subplots(1,1, figsize=(14,10))
ord_delays_180_df = ord_delays_df[ord_delays_df['ArrDelay'] < 180] 
ord_delays_180_df['ArrDelay'].plot(ax=ax1, kind='kde')
ax1.set_title("ORD Arrival Delay KDE Capped at 3 Hours");

\end{python}

Simple linear regression for exploration.

\begin{python}

dep_time_lm = sns.lmplot(data=ord_df, x='LateAircraftDelay', y='CarrierDelay', line_kws={'color':'red'})
dep_time_lm.set(title='Linear Regression Air Time by Arrival Delay')

\end{python}

%----------------------------------------------------------------------------------

\subsection{Models}

\subsubsection{Research Question 1} \label{model:rq1_code}

Imports for RQ1 Machine Learning Techniques.
\begin{python}
# General Imports
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.model_selection import train_test_split

# R1.1 Imports
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import accuracy_score, recall_score, precision_score
from sklearn.metrics import roc_curve, precision_recall_curve, roc_auc_score

#R1.2 Imports
from sklearn.metrics import confusion_matrix, ConfusionMatrixDisplay
from sklearn.metrics import classification_report

#R1.3 Imports
from sklearn.ensemble import RandomForestClassifier

df = pd.read_csv("../data/ORD_11_21-11-22_model.csv")
\end{python}

Logistic Regression (2 Classes)

\begin{python}
# Two class subset
df_x = df[['DOT_ID_Marketing_Airline', 'OriginAirportSeqID', 'DepTimeBlk', 'DestAirportSeqID', 'DepDelay', 'ArrTimeBlk', 'Distance', 'TaxiOut', 'CRSDepTime',
 'CRSArrTime', 'Quarter', 'Month', 'DayOfWeek']]
df_y = df['ArrDel15']

fit = LogisticRegression(solver='lbfgs', max_iter=10000, class_weight={0:15, 1:85}, random_state=15).fit(x_train, y_train)

y_pred = fit.predict(x_test)
y_prob = fit.predict_proba(x_test)
y_prob = y_prob[:,1] # want the positive values
\end{python}

Logistic Regression Confusion Matrix Evaluation

\begin{python}
fig, ax1 = plt.subplots(1,1, figsize=(14,10))

matrix = confusion_matrix(y_test, y_pred)
ConfusionMatrixDisplay(confusion_matrix=matrix).plot(ax=ax1)
ax1.set_title("Arrival Delay Confusion Matrix (Logistic Regression)")

print(f"Accuracy of Model: {accuracy_score(y_test, y_pred)}")
print(f"Precision of Model: {precision_score(y_test, y_pred)}")
print(f"Recall of Model: {recall_score(y_test, y_pred)}")
\end{python}

Logistic Regression ROC Curve Evaluation
\begin{python}
fig, ax1 = plt.subplots(1,1, figsize=(14,10))
fpr, tpr, _ = roc_curve(y_test, y_prob)
auc = roc_auc_score(y_test, y_prob)

print(f"AUC Score: {auc}")

ax1.plot(fpr, tpr)
ax1.set_ylabel('True Positive Rate')
ax1.set_xlabel('False Positive Rate')
ax1.set_title("Arrival Delay ROC Curve (Random Forrest Decision Tree)")
\end{python}

Logistic Regression Recall Vs. Precision Curve Evaluation
\begin{python}
fig, ax1 = plt.subplots(1,1, figsize=(14,10))
prec, recall, _ = precision_recall_curve(y_test, y_prob)

ax1.plot(prec, recall)
ax1.set_ylabel('Precision')
ax1.set_xlabel('Recall')
ax1.set_title("Arrival Delay Precision Vs. Recall (Logistic Regression)")
\end{python}

Logistic Regression (Multiple Classes)

Random Forrest Decision Tree (Multiple Classes)

%----------------------------------------------------------------------------------

\pagebreak

%TODO remove these and cite for real with BIBTEX
% \cite{doi:10.1080/01441647.2020.1861123}
% \cite{doi:10.1198/016214507000000257}
% \cite{HENRIQUES2018638}
% \cite{bts_table}

\section{References}
\bibliographystyle{plain}
\bibliography{rough_draft}

\end{document} 